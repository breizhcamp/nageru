From: Yoann Dubreuil <yoann.dubreuil@gmail.com>
Date: Sat, 23 Feb 2019 21:37:56 +0100
Subject: Display recording time

---
 nageru/mainwindow.cpp | 5 +++--
 nageru/mixer.cpp      | 1 +
 nageru/mixer.h        | 3 +++
 3 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/nageru/mainwindow.cpp b/nageru/mainwindow.cpp
index 834d23f..af439ac 100644
--- a/nageru/mainwindow.cpp
+++ b/nageru/mainwindow.cpp
@@ -808,6 +808,7 @@ void MainWindow::report_disk_space(off_t free_bytes, double estimated_seconds_le
 	
 	char uptime_str[256];
 	
+	uptime_seconds = global_mixer->get_pts_from_last_cut();
 	if (uptime_seconds < 60) {
 		snprintf(uptime_str, sizeof(uptime_str), "%" PRIu64 "s", uptime_seconds);
 	} else if (uptime_seconds < 3600) { // 1 minute
@@ -823,9 +824,9 @@ void MainWindow::report_disk_space(off_t free_bytes, double estimated_seconds_le
 		m %= 60;
 		snprintf(uptime_str, sizeof(uptime_str), "%dh %dm %ds", h, m, s);
 	}
-	
+
 	char buf[512];
-	snprintf(buf, sizeof(buf), "Local Time: %s - Uptime: %s - Disk free: %'.0f MB (approx. %s)", nowtime, uptime_str, free_bytes / 1048576.0, time_str);
+	snprintf(buf, sizeof(buf), "Local Time: %s - Recording time: %s - Disk free: %'.0f MB (approx. %s)", nowtime, uptime_str, free_bytes / 1048576.0, time_str);
 
 	std::string label = buf;
 
diff --git a/nageru/mixer.cpp b/nageru/mixer.cpp
index 9fd1e15..8082d87 100644
--- a/nageru/mixer.cpp
+++ b/nageru/mixer.cpp
@@ -1105,6 +1105,7 @@ void Mixer::thread_func()
 
 		if (should_cut.exchange(false)) {  // Test and clear.
 			video_encoder->do_cut(frame_num);
+			pts_int_last_cut = pts_int;
 		}
 
 #if 0
diff --git a/nageru/mixer.h b/nageru/mixer.h
index b4ed76f..eff059a 100644
--- a/nageru/mixer.h
+++ b/nageru/mixer.h
@@ -297,6 +297,8 @@ public:
 		should_cut = true;
 	}
 
+	unsigned get_pts_from_last_cut() const { return double(pts_int - pts_int_last_cut) / TIMEBASE ; }
+
 	unsigned get_num_cards() const { return num_cards; }
 
 	std::string get_card_description(unsigned card_index) const {
@@ -486,6 +488,7 @@ private:
 	movit::YCbCrInput *display_input;
 
 	int64_t pts_int = 0;  // In TIMEBASE units.
+	int64_t pts_int_last_cut = 0;  // In TIMEBASE units.
 
 	mutable std::mutex frame_num_mutex;
 	std::condition_variable frame_num_updated;
